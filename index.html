<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NoteChat</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
    <div class="container">
        <div id="menu" class="menu-section">
            <h1>NoteChat</h1>
            <div class="menu-buttons">
                <button onclick="showCreateForm()">Create new room</button>
                <button class="secondary" onclick="showLoginForm()">Login</button>
            </div>
        </div>

        <div id="createForm" class="form-section">
            <h2>Create new room</h2>
            <div class="form-group">
                <label>Room name:</label>
                <input type="text" id="createName" placeholder="Enter room name">
                <div class="error" id="createNameError"></div>
            </div>
            <div class="form-group">
                <label>Password:</label>
                <input type="password" id="createPassword" placeholder="Enter password">
            </div>
            <div class="form-buttons">
                <button onclick="createRoom()">Create</button>
                <button class="secondary" onclick="backToMenu()">Back</button>
            </div>
        </div>

        <div id="loginForm" class="form-section">
            <h2>Login</h2>
            <div class="form-group">
                <label>Room name:</label>
                <input type="text" id="loginName" placeholder="Enter room name">
                <div class="error" id="loginNameError"></div>
            </div>
            <div class="form-group">
                <label>Password:</label>
                <input type="password" id="loginPassword" placeholder="Enter password">
            </div>
            <div class="form-buttons">
                <button onclick="loginRoom()">Login</button>
                <button class="secondary" onclick="backToMenu()">Back</button>
            </div>
        </div>

        <div id="chat">
            <div class="chat-header">
                <h2 id="currentRoomName"></h2>
                <div id="connectionStatus">ðŸŸ¢ Connected</div>
            </div>
            <div id="messages" class="messages"></div>
            <div class="chat-input">
                <input type="text" id="messageInput" placeholder="Type message..." onkeypress="if(event.key === 'Enter') sendMessage()">
                <button onclick="sendMessage()">Send</button>
                <button class="secondary" onclick="clearRoom()">Clear All</button>
                <button class="secondary" onclick="logout()">Logout</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://notechat-xoxh.onrender.com/api';
        let socket = null;
        let currentRoom = null;
        let currentPassword = null;

        function initSocket() {
            socket = io(API_URL.replace('/api', ''), {
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionAttempts: 5
            });

            socket.on('connect', () => {
                document.getElementById('connectionStatus').innerText = 'ðŸŸ¢ Connected';
            });

            socket.on('disconnect', () => {
                document.getElementById('connectionStatus').innerText = 'ðŸ”´ Disconnected';
            });

            socket.on('new_post', (data) => {
                addMessageToUI(data.id, data.content, data.created_at);
            });

            socket.on('post_deleted', (data) => {
                const el = document.querySelector(`[data-id="${data.id}"]`);
                if (el) el.remove();
            });

            socket.on('room_cleared', () => {
                document.getElementById('messages').innerHTML = '';
            });

            socket.on('error', (data) => {
                console.error('Socket error:', data.message);
            });
        }

        function addMessageToUI(id, content, createdAt) {
            const messagesDiv = document.getElementById('messages');
            const msgEl = document.createElement('div');
            msgEl.className = 'message';
            msgEl.setAttribute('data-id', id);
            
            const time = new Date(createdAt).toLocaleTimeString();
            
            msgEl.innerHTML = `
                <div class="message-content">${escapeHtml(content)}</div>
                <div class="message-time">${time}</div>
                <button class="delete-btn" onclick="deleteMessage('${id}')">Ã—</button>
            `;
            
            messagesDiv.appendChild(msgEl);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showCreateForm() {
            document.querySelector('.menu-section').style.display = 'none';
            document.getElementById('createForm').classList.add('active');
            document.getElementById('createNameError').innerText = '';
        }

        function showLoginForm() {
            document.querySelector('.menu-section').style.display = 'none';
            document.getElementById('loginForm').classList.add('active');
            document.getElementById('loginNameError').innerText = '';
        }

        function backToMenu() {
            document.querySelectorAll('.form-section').forEach(f => f.classList.remove('active'));
            document.getElementById('chat').classList.remove('active');
            document.querySelector('.menu-section').style.display = 'block';
        }

        async function createRoom() {
            const name = document.getElementById('createName').value.trim();
            const password = document.getElementById('createPassword').value;
            const errorEl = document.getElementById('createNameError');

            if (!name || !password) {
                errorEl.innerText = 'Fill all fields';
                return;
            }

            try {
                const res = await fetch(`${API_URL}/rooms/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, password })
                });
                const data = await res.json();

                if (!res.ok) {
                    errorEl.innerText = data.error;
                    return;
                }

                currentRoom = name;
                currentPassword = password;
                openChat();
            } catch (err) {
                errorEl.innerText = 'Connection error';
            }
        }

        async function loginRoom() {
            const name = document.getElementById('loginName').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('loginNameError');

            if (!name || !password) {
                errorEl.innerText = 'Fill all fields';
                return;
            }

            try {
                const res = await fetch(`${API_URL}/rooms/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, password })
                });
                const data = await res.json();

                if (!res.ok) {
                    errorEl.innerText = data.error;
                    return;
                }

                currentRoom = name;
                currentPassword = password;
                openChat(data.posts);
            } catch (err) {
                errorEl.innerText = 'Connection error';
            }
        }

        function openChat(posts = []) {
            document.querySelectorAll('.form-section').forEach(f => f.classList.remove('active'));
            document.getElementById('chat').classList.add('active');
            document.getElementById('currentRoomName').innerText = currentRoom;
            
            if (!socket) initSocket();
            
            socket.emit('join_room', {
                name: currentRoom,
                password: currentPassword
            });

            document.getElementById('messages').innerHTML = '';
            posts.forEach(post => {
                addMessageToUI(post.id, post.content, post.created_at);
            });
            
            document.getElementById('messageInput').focus();
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            
            if (!content) return;
            
            socket.emit('post_message', {
                room: currentRoom,
                content: content
            });
            
            input.value = '';
            input.focus();
        }

        function deleteMessage(postId) {
            socket.emit('delete_post', {
                room: currentRoom,
                id: postId
            });
        }

        function clearRoom() {
            if (confirm('Clear all messages?')) {
                socket.emit('clear_room', {
                    room: currentRoom
                });
            }
        }

        function logout() {
            if (socket && currentRoom) {
                socket.emit('leave_room', { room: currentRoom });
            }
            currentRoom = null;
            currentPassword = null;
            backToMenu();
        }

        initSocket();
    </script>
</body>
</html>
