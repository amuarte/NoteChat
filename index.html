<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NoteChat</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
    <div class="container">
        <div id="menu" class="menu-section">
            <h1>NoteChat</h1>
            <div class="menu-buttons">
                <button onclick="showCreateForm()">Create new note</button>
                <button class="secondary" onclick="showLoginForm()">Login</button>
            </div>
        </div>

        <div id="createForm" class="form-section">
            <h2>Create new note</h2>
            <div class="form-group">
                <label>Note name:</label>
                <input type="text" id="createName" placeholder="Enter note name">
                <div class="error" id="createNameError"></div>
            </div>
            <div class="form-group">
                <label>Password:</label>
                <input type="password" id="createPassword" placeholder="Enter password">
            </div>
            <div class="form-buttons">
                <button onclick="createNote()">Create</button>
                <button class="secondary" onclick="backToMenu()">Back</button>
            </div>
        </div>

        <div id="loginForm" class="form-section">
            <h2>Login</h2>
            <div class="form-group">
                <label>Note name:</label>
                <input type="text" id="loginName" placeholder="Enter note name">
                <div class="error" id="loginNameError"></div>
            </div>
            <div class="form-group">
                <label>Password:</label>
                <input type="password" id="loginPassword" placeholder="Enter password">
            </div>
            <div class="form-buttons">
                <button onclick="loginNote()">Login</button>
                <button class="secondary" onclick="backToMenu()">Back</button>
            </div>
        </div>

        <div id="editor">
            <h2>Note editor</h2>
            <div class="note-header">
                <div class="note-name" id="currentNoteName"></div>
                <div class="connection-status" id="connectionStatus">ðŸŸ¢ Connected</div>
            </div>
            <textarea id="noteContent" placeholder="Start typing..."></textarea>
            <div class="editor-buttons">
                <span id="userCount" class="info-text"></span>
                <button class="secondary" onclick="logout()">Logout</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://notechat-xoxh.onrender.com/api';
        let socket = null;
        let currentNote = null;
        let currentPassword = null;
        let isRemoteChange = false;
        let lastContent = '';
        let version = 0;

        function initSocket() {
            socket = io(API_URL.replace('/api', ''), {
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionAttempts: 5
            });

            socket.on('connect', () => {
                updateConnectionStatus('ðŸŸ¢ Connected');
            });

            socket.on('disconnect', () => {
                updateConnectionStatus('ðŸ”´ Disconnected');
            });

            socket.on('sync', (data) => {
                lastContent = data.content;
                version = data.version;
                const textarea = document.getElementById('noteContent');
                textarea.value = data.content;
            });

            socket.on('operation', (data) => {
                applyRemoteOperation(data.op);
                version = data.version;
            });

            socket.on('user_count', (data) => {
                updateUserCount(data.count);
            });

            socket.on('error', (data) => {
                console.error('Socket error:', data.message);
            });
        }

        function applyRemoteOperation(op) {
            const textarea = document.getElementById('noteContent');
            const cursorPos = textarea.selectionStart;
            
            if (op.type === 'insert') {
                lastContent = lastContent.slice(0, op.pos) + op.text + lastContent.slice(op.pos);
                if (cursorPos >= op.pos) {
                    textarea.value = lastContent;
                    textarea.setSelectionRange(cursorPos + op.text.length, cursorPos + op.text.length);
                } else {
                    textarea.value = lastContent;
                    textarea.setSelectionRange(cursorPos, cursorPos);
                }
            } else if (op.type === 'delete') {
                lastContent = lastContent.slice(0, op.pos) + lastContent.slice(op.pos + op.length);
                if (cursorPos > op.pos) {
                    const newPos = Math.max(op.pos, cursorPos - op.length);
                    textarea.value = lastContent;
                    textarea.setSelectionRange(newPos, newPos);
                } else {
                    textarea.value = lastContent;
                    textarea.setSelectionRange(cursorPos, cursorPos);
                }
            }
        }

        function updateConnectionStatus(status) {
            const el = document.getElementById('connectionStatus');
            if (el) el.innerText = status;
        }

        function updateUserCount(count) {
            const el = document.getElementById('userCount');
            if (el) el.innerText = `ðŸ‘¥ ${count} user(s)`;
        }

        function showCreateForm() {
            document.querySelector('.menu-section').style.display = 'none';
            document.getElementById('createForm').classList.add('active');
            document.getElementById('createNameError').innerText = '';
        }

        function showLoginForm() {
            document.querySelector('.menu-section').style.display = 'none';
            document.getElementById('loginForm').classList.add('active');
            document.getElementById('loginNameError').innerText = '';
        }

        function backToMenu() {
            document.querySelectorAll('.form-section').forEach(f => f.classList.remove('active'));
            document.getElementById('editor').classList.remove('active');
            document.querySelector('.menu-section').style.display = 'block';
        }

        async function createNote() {
            const name = document.getElementById('createName').value.trim();
            const password = document.getElementById('createPassword').value;
            const errorEl = document.getElementById('createNameError');

            if (!name || !password) {
                errorEl.innerText = 'Fill all fields';
                return;
            }

            try {
                const res = await fetch(`${API_URL}/notes/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, password })
                });
                const data = await res.json();

                if (!res.ok) {
                    errorEl.innerText = data.error;
                    return;
                }

                currentNote = name;
                currentPassword = password;
                openEditor();
            } catch (err) {
                errorEl.innerText = 'Connection error';
            }
        }

        async function loginNote() {
            const name = document.getElementById('loginName').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('loginNameError');

            if (!name || !password) {
                errorEl.innerText = 'Fill all fields';
                return;
            }

            try {
                const res = await fetch(`${API_URL}/notes/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, password })
                });
                const data = await res.json();

                if (!res.ok) {
                    errorEl.innerText = data.error;
                    return;
                }

                currentNote = name;
                currentPassword = password;
                lastContent = data.content || '';
                version = data.version || 0;
                document.getElementById('noteContent').value = lastContent;
                openEditor();
            } catch (err) {
                errorEl.innerText = 'Connection error';
            }
        }

        function openEditor() {
            document.querySelectorAll('.form-section').forEach(f => f.classList.remove('active'));
            document.getElementById('editor').classList.add('active');
            document.getElementById('currentNoteName').innerText = `Note: ${currentNote}`;
            
            if (!socket) initSocket();
            
            socket.emit('join_note', {
                name: currentNote,
                password: currentPassword
            });

            const textarea = document.getElementById('noteContent');
            textarea.addEventListener('input', (e) => {
                if (isRemoteChange) return;
                
                const newContent = textarea.value;
                const op = computeDelta(lastContent, newContent);
                
                if (op) {
                    socket.emit('operation', {
                        name: currentNote,
                        op: op
                    });
                    lastContent = newContent;
                }
            });
        }

        function computeDelta(oldText, newText) {
            if (oldText === newText) return null;
            
            let i = 0;
            while (i < oldText.length && i < newText.length && oldText[i] === newText[i]) {
                i++;
            }
            
            let oldEnd = oldText.length - 1;
            let newEnd = newText.length - 1;
            
            while (oldEnd >= i && newEnd >= i && oldText[oldEnd] === newText[newEnd]) {
                oldEnd--;
                newEnd--;
            }
            
            const pos = i;
            const deletedLength = oldEnd - i + 1;
            const insertedText = newText.slice(i, newEnd + 1);
            
            if (deletedLength === 0) {
                return { type: 'insert', pos: pos, text: insertedText };
            } else if (insertedText.length === 0) {
                return { type: 'delete', pos: pos, length: deletedLength };
            } else {
                return { type: 'delete', pos: pos, length: deletedLength };
            }
        }

        function logout() {
            if (socket && currentNote) {
                socket.emit('leave_note', { name: currentNote });
            }
            currentNote = null;
            currentPassword = null;
            lastContent = '';
            document.getElementById('noteContent').value = '';
            backToMenu();
        }

        initSocket();
    </script>
</body>
</html>
