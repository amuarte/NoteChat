<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatNotes</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div id="menu" class="menu-section">
            <h1>ChatNotes</h1>
            <div class="menu-buttons">
                <button onclick="showCreateForm()">Create new note</button>
                <button class="secondary" onclick="showLoginForm()">Login</button>
            </div>
        </div>

        <div id="createForm" class="form-section">
            <h2>Create new note</h2>
            <div class="form-group">
                <label>Note name:</label>
                <input type="text" id="createName" placeholder="Enter note name">
                <div class="error" id="createNameError"></div>
            </div>
            <div class="form-group">
                <label>Password:</label>
                <input type="password" id="createPassword" placeholder="Enter password">
            </div>
            <div class="form-buttons">
                <button onclick="createNote()">Create</button>
                <button class="secondary" onclick="backToMenu()">Back</button>
            </div>
        </div>

        <div id="loginForm" class="form-section">
            <h2>Login</h2>
            <div class="form-group">
                <label>Note name:</label>
                <input type="text" id="loginName" placeholder="Enter note name">
                <div class="error" id="loginNameError"></div>
            </div>
            <div class="form-group">
                <label>Password:</label>
                <input type="password" id="loginPassword" placeholder="Enter password">
            </div>
            <div class="form-buttons">
                <button onclick="loginNote()">Login</button>
                <button class="secondary" onclick="backToMenu()">Back</button>
            </div>
        </div>

        <div id="editor">
            <h2>Note editor</h2>
            <div class="note-name" id="currentNoteName"></div>
            <textarea id="noteContent" placeholder="Start typing..." oninput="autoSave()"></textarea>
            <div class="editor-buttons">
                <button class="secondary" onclick="logout()">Logout</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://notechat-xoxh.onrender.com/api';
        let currentNote = null;
        let currentPassword = null;
        let autoRefreshInterval = null;

        function showCreateForm() {
            document.querySelector('.menu-section').style.display = 'none';
            document.getElementById('createForm').classList.add('active');
            document.getElementById('createNameError').innerText = '';
        }

        function showLoginForm() {
            document.querySelector('.menu-section').style.display = 'none';
            document.getElementById('loginForm').classList.add('active');
            document.getElementById('loginNameError').innerText = '';
        }

        function backToMenu() {
            document.querySelectorAll('.form-section').forEach(f => f.classList.remove('active'));
            document.getElementById('editor').classList.remove('active');
            document.querySelector('.menu-section').style.display = 'block';
        }

        async function createNote() {
            const name = document.getElementById('createName').value.trim();
            const password = document.getElementById('createPassword').value;
            const errorEl = document.getElementById('createNameError');

            if (!name || !password) {
                errorEl.innerText = 'Fill all fields';
                return;
            }

            try {
                const res = await fetch(`${API_URL}/notes/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, password })
                });
                const data = await res.json();

                if (!res.ok) {
                    errorEl.innerText = data.error;
                    return;
                }

                currentNote = name;
                currentPassword = password;
                openEditor();
            } catch (err) {
                errorEl.innerText = 'Connection error';
            }
        }

        async function loginNote() {
            const name = document.getElementById('loginName').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('loginNameError');

            if (!name || !password) {
                errorEl.innerText = 'Fill all fields';
                return;
            }

            try {
                const res = await fetch(`${API_URL}/notes/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, password })
                });
                const data = await res.json();

                if (!res.ok) {
                    errorEl.innerText = data.error;
                    return;
                }

                currentNote = name;
                currentPassword = password;
                openEditor();
                document.getElementById('noteContent').value = data.content || '';
            } catch (err) {
                errorEl.innerText = 'Connection error';
            }
        }

        function openEditor() {
            document.querySelectorAll('.form-section').forEach(f => f.classList.remove('active'));
            document.getElementById('editor').classList.add('active');
            document.getElementById('currentNoteName').innerText = `Note: ${currentNote}`;
            startAutoRefresh();
        }

        async function autoSave() {
            if (!currentNote) return;

            try {
                await fetch(`${API_URL}/notes/${currentNote}/save`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: document.getElementById('noteContent').value,
                        password: currentPassword
                    })
                });
            } catch (err) {
                console.log('Auto save failed');
            }
        }

        async function autoRefresh() {
            if (!currentNote) return;

            try {
                const res = await fetch(`${API_URL}/notes/${currentNote}`);
                const data = await res.json();
                const textarea = document.getElementById('noteContent');
                if (textarea.value !== data.content) {
                    textarea.value = data.content;
                }
            } catch (err) {
                console.log('Auto refresh failed');
            }
        }

        function startAutoRefresh() {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            autoRefreshInterval = setInterval(autoRefresh, 2000);
        }

        function logout() {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            currentNote = null;
            currentPassword = null;
            backToMenu();
        }
    </script>
</body>
</html>
